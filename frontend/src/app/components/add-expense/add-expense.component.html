<div class="add-expense-dialog">
  <div class="dialog-header">
    <i class="pi pi-credit-card header-icon"></i>
    <h2>Add New Expense</h2>
  </div>
  
  <form [formGroup]="expenseForm" (ngSubmit)="onSubmit()">
    <div class="dialog-content">
      <div class="form-field">
        <label for="expenseDescription" class="form-label">Description *</label>
        <p-inputtext 
          id="expenseDescription"
          formControlName="description" 
          placeholder="Enter expense description"
          class="full-width"
          [class.ng-invalid]="expenseForm.get('description')?.invalid && expenseForm.get('description')?.touched">
        </p-inputtext>
        <small class="error-message" *ngIf="expenseForm.get('description')?.invalid && expenseForm.get('description')?.touched">
          <i class="pi pi-exclamation-triangle"></i>
          <span *ngIf="expenseForm.get('description')?.hasError('required')">Description is required</span>
          <span *ngIf="expenseForm.get('description')?.hasError('maxlength')">Description cannot exceed 200 characters</span>
        </small>
      </div>

      <div class="form-field">
        <label for="expenseAmount" class="form-label">Amount *</label>
        <p-inputnumber 
          id="expenseAmount"
          formControlName="amount" 
          placeholder="0.00" 
          mode="currency" 
          currency="USD"
          class="full-width"
          [class.ng-invalid]="expenseForm.get('amount')?.invalid && expenseForm.get('amount')?.touched">
        </p-inputnumber>
        <small class="error-message" *ngIf="expenseForm.get('amount')?.invalid && expenseForm.get('amount')?.touched">
          <i class="pi pi-exclamation-triangle"></i>
          <span *ngIf="expenseForm.get('amount')?.hasError('required')">Amount is required</span>
          <span *ngIf="expenseForm.get('amount')?.hasError('min')">Amount must be greater than 0</span>
        </small>
      </div>

      <div class="form-field">
        <label for="splitType" class="form-label">Split Type *</label>
        <p-dropdown 
          id="splitType"
          formControlName="splitType"
          [options]="splitTypeOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Select split type"
          class="full-width">
        </p-dropdown>
      </div>

      <div class="group-info">
        <h4><i class="pi pi-users"></i> Group: {{ selectedGroup.name }}</h4>
        <p><i class="pi pi-user"></i> Paid by: {{ currentUser.firstName }} {{ currentUser.lastName }}</p>
      </div>

      <!-- Custom shares form for non-equal splits -->
      <div class="shares-section" *ngIf="selectedSplitType !== 'EQUAL'">
        <h4>Split Details</h4>
        
        <!-- No shares message -->
        <div class="no-shares-message" *ngIf="sharesArray.length === 0" style="background: #fff3cd; padding: 12px; border-radius: 4px; margin: 16px 0;">
          <i class="pi pi-info-circle"></i>
          <span>No group members found to split with. Please check your group configuration.</span>
        </div>
        
        <!-- Validation Error Message -->
        <div class="validation-error" *ngIf="getSharesErrorMessage()">
          <i class="pi pi-exclamation-triangle"></i>
          <span>{{ getSharesErrorMessage() }}</span>
        </div>
        
        <div class="shares-form" formArrayName="shares">
          <div class="share-item" *ngFor="let share of sharesArray.controls; let i = index" [formGroupName]="i">
            <div class="share-header">
              <span class="member-name">{{ getMemberName(share.get('userId')?.value) }}</span>
            </div>
            
            <div class="share-inputs">
              <!-- Amount field for CUSTOM split -->
              <div class="amount-input" *ngIf="selectedSplitType === 'CUSTOM'">
                <label class="form-label">Amount *</label>
                <p-inputnumber 
                  formControlName="amount" 
                  placeholder="0.00" 
                  mode="currency" 
                  currency="USD"
                  class="full-width">
                </p-inputnumber>
                <small class="error-message" *ngIf="share.get('amount')?.hasError('required')">
                  <i class="pi pi-exclamation-triangle"></i>
                  Amount is required
                </small>
              </div>
              
              <!-- Percentage field for PERCENTAGE split -->
              <div class="percentage-input" *ngIf="selectedSplitType === 'PERCENTAGE'">
                <label class="form-label">Percentage *</label>
                <p-inputnumber 
                  formControlName="percentage" 
                  placeholder="0" 
                  suffix="%"
                  class="full-width">
                </p-inputnumber>
                <small class="error-message" *ngIf="share.get('percentage')?.hasError('required')">
                  <i class="pi pi-exclamation-triangle"></i>
                  Percentage is required
                </small>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Split Summary -->
        <div class="split-summary">
          <p *ngIf="selectedSplitType === 'PERCENTAGE'">
            Total: {{ getTotalPercentage() }}%
          </p>
          <p *ngIf="selectedSplitType === 'CUSTOM'">
            Total: ${{ getTotalCustomAmount() }} / ${{ expenseForm.get('amount')?.value || 0 }}
          </p>
        </div>
      </div>

      <div class="info-note" *ngIf="selectedSplitType === 'EQUAL'">
        <i class="pi pi-info-circle"></i>
        <span>This expense will be split equally among all group members.</span>
      </div>
    </div>

    <div class="dialog-actions">
      <p-button 
        type="button" 
        severity="secondary" 
        (onClick)="onCancel()"
        label="Cancel">
      </p-button>
      
      <p-button 
        type="submit" 
        severity="primary" 
        [disabled]="expenseForm.invalid || loading"
        [loading]="loading"
        label="Add Expense">
      </p-button>
    </div>
  </form>
</div>
